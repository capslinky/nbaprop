# Plan: 12-20-2025 fixes

This plan addresses the 15 critical issues identified in the `nbaprop` repo review (dependency reproducibility, config correctness, git hygiene, security, model correctness, pipeline consistency, and tests).

## Requirements
- Produce a reproducible, documented Python environment (runtime + dev).
- Ensure secrets (API keys/webhooks) are never committed or logged.
- Make `UnifiedPropModel` context-aware and mathematically correct (recent/older windows, prop type mapping, injury handling).
- Eliminate inconsistent analysis logic between entry points (`nba_quickstart.py`, `analysis/live_analyzer.py`, `app.py`, `daily_runner.py`).
- Add targeted tests that fail on the current bugs and pass after fixes.

## Scope
- In:
  - Dependency management + docs updates
  - Config env overrides + validation
  - Gitignore + artifact/caches hygiene
  - `UnifiedPropModel` correctness + context inference
  - `LivePropAnalyzer.find_value_props` refactor/realignment to `UnifiedPropModel`
  - Fix broken context wiring in `nba_quickstart.py`
  - Security/logging fixes (webhook masking)
  - Test/mocks alignment + new regression tests
- Out:
  - New modeling features or strategy changes beyond fixing correctness/inconsistency
  - Major redesign of data sources (unless required to fix context inference)

## Files and entry points (most impacted)
- Environment/deps/docs: `README.md`, add `requirements.txt`, add `requirements-dev.txt` (or `pyproject.toml`)
- Git hygiene: `.gitignore`, potentially move/write outputs to an `artifacts/` directory
- Config: `core/config.py`
- Alerts/logging: `core/alerts.py`, `core/logging_config.py`, `daily_runner.py`
- Core model: `models/unified.py`, `models/prop_analysis.py`, `data/fetchers/nba_fetcher.py`, `data/fetchers/odds_fetcher.py`
- Analysis pipeline: `analysis/live_analyzer.py`, `nba_quickstart.py`, `app.py`
- Tests: `tests/mocks.py`, `tests/unit/test_unified_model.py`, plus new tests covering regressions

## Issue → Fix mapping (what changes where)
1. Missing reproducible dependency spec
   - Add `requirements.txt` (runtime) + `requirements-dev.txt` (dev/test) OR adopt `pyproject.toml`.
   - Ensure dependencies match imports: `nba_api`, `pandas`, `numpy`, `scipy`, `openpyxl`, `requests`, `streamlit`, plus `python-dotenv` and `aiohttp`.
   - Update `README.md` install instructions accordingly.
2. `core.config` env override claim is false
   - Implement typed env override for all config fields (float/int/bool/list) with a consistent prefix (e.g. `NBAPROP_*`).
   - Add validation (ranges for weights/factors) and expose a `CONFIG.dump()` or `CONFIG.to_dict()` for debugging.
3. `.gitignore` missing caches/artifacts
   - Ignore schedule cache(s), `.pytest_cache/`, Streamlit cache dirs, generated picks/reports/PDFs, local DBs, and other outputs.
4. Generated outputs present in repo
   - Decide on policy: keep small samples under `examples/` and ignore everything else.
   - Update scripts to write to `artifacts/` (date-stamped) by default.
5. Webhook URLs partially logged
   - Mask/hide URLs in handler `.name` and any log lines (log “slack webhook configured” vs printing the URL).
6. `UnifiedPropModel` context auto-detection incomplete
   - Fix `_detect_context_from_logs` to populate `is_home` from logs and (when possible) resolve tonight’s opponent using odds events/schedule.
   - Add a dedicated `_resolve_game_context()` that uses:
     - roster team (from `core/rosters.get_player_team`)
     - odds events (`OddsAPIClient.get_events()`)
     - game lines (`OddsAPIClient.get_game_lines()`)
7. `UnifiedPropModel` doesn’t fill `game_total` / `blowout_risk`
   - Implement matching between (player_team, opponent) and odds `game_lines` to set `game_total`, `blowout_risk`.
8. Recent/older windows are reversed (math bug)
   - Standardize on “logs sorted newest-first” and use `.head()` for recent slices everywhere (projection, trend, confidence).
   - Add tests that catch incorrect window selection.
9. `threes` prop type often returns `NO DATA`
   - Normalize prop types: treat `threes` as alias for `fg3m` (either add `logs['threes'] = logs['fg3m']` in fetcher, or map in model).
   - Ensure `CONFIG.VALID_PROP_TYPES` and model mapping align.
10. OUT players are not excluded from picks
   - If `InjuryTracker` returns `is_out=True` (or equivalent), return a `PASS` `PropAnalysis` with explicit flags and confidence 0.
11. `nba_quickstart.py` passes bogus `opponent`/`is_home`
   - Remove string-based heuristics; pass `opponent/is_home` only when derived from the event teams (via roster team + odds event matching), otherwise let model auto-resolve.
12. `find_value_props` duplicates model logic
   - Refactor to be a thin orchestrator:
     - fetch props and game context
     - call `UnifiedPropModel.analyze()` per prop with consistent inputs
     - compute/standardize output columns
   - Deprecate or remove the bespoke projection/edge pipeline (mean reversion + placeholder adjustments) unless explicitly needed.
13. `find_value_props` home/away logic is wrong
   - Replace `event_info` assumptions with `home_team/away_team` from odds data and the player’s team.
14. `find_value_props` opponent defense is a placeholder
   - Remove placeholder; rely on `UnifiedPropModel` defense adjustment (which should use resolved opponent).
15. Tests/mocks don’t validate key behaviors and contracts drift
   - Align mocks with production method contracts (e.g. `rest_days` key, minutes trend keys).
   - Add regression tests for:
     - recent/older split correctness
     - `threes` alias handling
     - “OUT ⇒ PASS”
     - `nba_quickstart` context wiring correctness
     - config env overrides parsing

## Action items (ordered, deliverable-focused)
[ ] 1) Git hygiene + artifacts policy
    - Update `.gitignore` to cover caches and generated files.
    - Decide what (if anything) stays committed as examples; move sample(s) to `examples/` and ignore the rest.
    - Update scripts to write outputs to `artifacts/` by default.
[ ] 2) Dependency reproducibility
    - Add dependency file(s) (`requirements.txt` + `requirements-dev.txt` or `pyproject.toml`).
    - Update `README.md` to reference the exact install commands and optional extras.
[ ] 3) Config env override + validation
    - Implement typed env override for all config fields in `core/config.py`.
    - Add range validation and a debug dump method to quickly confirm runtime config.
[ ] 4) Secrets/logging hardening
    - Mask webhook URLs in `core/alerts.py` and avoid logging full URLs in `daily_runner.py`.
    - Ensure `.env` and other secret-bearing files are ignored and not referenced in docs as committed artifacts.
[ ] 5) Fix `UnifiedPropModel` correctness
    - Correct recent/older selection and trend calculations.
    - Normalize prop type to column mapping (`threes` ⇄ `fg3m`) consistently.
    - Treat “player OUT” as an automatic `PASS`.
[ ] 6) Implement real context inference in `UnifiedPropModel`
    - Add `_resolve_game_context()` using roster team + odds events + game lines.
    - Populate `opponent`, `is_home`, `game_total`, `blowout_risk` when absent.
    - Add safe fallbacks when games aren’t found (keep warnings/context_quality honest).
[ ] 7) Fix caller wiring (`nba_quickstart.py`, `app.py`, `daily_runner.py`)
    - Remove incorrect heuristics for opponent/home.
    - Standardize on passing raw event context (home/away teams, game id) or letting model infer.
[ ] 8) Refactor `LivePropAnalyzer.find_value_props` to use `UnifiedPropModel`
    - Make it an orchestrator + formatter, not a second model.
    - Ensure edge/confidence thresholds are applied consistently across entry points.
[ ] 9) Tests + regression suite
    - Fix mocks to match production keys/behavior.
    - Add tests that fail on the identified bugs and pass after fixes.
    - Keep unit tests fast; add minimal integration tests only where needed.

## Testing and validation
- Unit tests: `python3 -m pytest`
- Sanity checks:
  - `python3 validate_system.py --verbose`
  - Run one known-player analysis with and without odds client to confirm:
    - recent/older windows
    - `threes` mapping
    - “OUT ⇒ PASS”
    - context inference sets opponent/home/total/blowout when odds available
- Manual runtime:
  - `python3 daily_runner.py --pre-game --dry-run` (no external calls)
  - `streamlit run app.py` (interactive smoke test once dependencies are installed)

## Risks and edge cases
- Odds API quota/rate limits; ensure caching and avoid per-player event scans.
- Roster/team mapping drift (player traded; roster JSON stale); model must degrade gracefully with warnings.
- Ambiguous player names / suffixes; ensure player lookup and injury matching remain robust.
- Games not found (no odds posted yet); context inference should not break analysis.
- Timezone issues when matching “today” games; prefer event IDs from props payload when available.

## Open questions (answer before implementation if possible)
- Do you want a pip-only workflow (`requirements*.txt`) or Poetry/uv (`pyproject.toml`)?
- Should the repo keep *any* example outputs (small CSV) for documentation, or keep it completely clean?
- Should `find_value_props` preserve its current mean-reversion heuristics, or fully defer to `UnifiedPropModel`?
